name: Build Windows Desktop Application

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    env:
      PYTHON_VERSION: '3.12'
      NODE_VERSION: '20'
      APP_NAME: 'Enterprise Backup System'
      APP_VERSION: '1.0.0'
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Show workspace structure
      run: |
        echo "=== WORKSPACE DEBUG ==="
        echo "Workspace: ${{ github.workspace }}"
        echo "Current directory: $(pwd)"
        dir
        echo ""
        echo "=== CHECKING app DIRECTORY ==="
        if (Test-Path "${{ github.workspace }}\app") {
          echo "âœ… app directory found"
          dir "${{ github.workspace }}\app"
        } else {
          echo "âŒ app directory not found"
          dir "${{ github.workspace }}"
          exit 1
        }
        echo ""
        echo "=== CHECKING desktop-app DIRECTORY ==="
        if (Test-Path "${{ github.workspace }}\desktop-app") {
          echo "âœ… desktop-app directory found"
          dir "${{ github.workspace }}\desktop-app"
        } else {
          echo "âŒ desktop-app directory not found"
          dir "${{ github.workspace }}"
          exit 1
        }
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: '${{ github.workspace }}\app\requirements.txt'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '${{ github.workspace }}\desktop-app\package.json'
        
    - name: Create placeholder assets if missing
      run: |
        Write-Host "ğŸ¯ Ensuring assets directory exists..."
        
        # Create assets directory using Force parameter
        $assetsPath = "${{ github.workspace }}\desktop-app\assets"
        New-Item -ItemType Directory -Force -Path $assetsPath | Out-Null
        Write-Host "âœ… Created/verified assets directory: $assetsPath"
        
        # Check if icon.ico exists (should be committed to repo)
        $iconPath = "$assetsPath\icon.ico"
        if (Test-Path $iconPath) {
          Write-Host "âœ… Real icon.ico found at: $iconPath"
          $iconInfo = Get-ChildItem $iconPath
          Write-Host "ğŸ“Š Icon size: $($iconInfo.Length) bytes"
          if ($iconInfo.Length -lt 1000) {
            Write-Host "âš ï¸  Icon seems too small, should be at least 256x256 pixels"
          }
        } else {
          Write-Host "âŒ icon.ico not found at: $iconPath"
          Write-Host "âš ï¸  Please commit a real 256x256 icon.ico file to desktop-app/assets/"
          Write-Host "ğŸ“ Current assets directory contents:"
          Get-ChildItem $assetsPath | Select-Object Name, Length
          exit 1
        }
        
        # Only create installer.nsh (icon.ico should be in repo)
        $installerPath = "$assetsPath\installer.nsh"
        if (!(Test-Path $installerPath)) {
          Write-Host "ğŸ“„ Creating placeholder installer.nsh..."
          echo "; Custom installer script" | Out-File -FilePath $installerPath -Encoding UTF8
          Write-Host "âœ… Created installer.nsh at: $installerPath"
        } else {
          Write-Host "âœ… installer.nsh already exists at: $installerPath"
        }
        
        # Verify final assets
        Write-Host "ğŸ“ Final assets directory contents:"
        Get-ChildItem $assetsPath | Select-Object Name, Length
        
    - name: Install Node.js dependencies
      run: |
        Write-Host "ğŸ“¦ Installing Node.js dependencies..."
        cd "${{ github.workspace }}\desktop-app"
        npm install --production=false
        
    - name: Install Python dependencies
      run: |
        Write-Host "ğŸ Installing Python dependencies..."
        python -m pip install --upgrade pip setuptools wheel
        pip install -r "${{ github.workspace }}\app\requirements.txt"
        pip install pyinstaller==6.3.0
        
    - name: Verify Python installation
      run: |
        Write-Host "ğŸ” Verifying Python installation..."
        python --version
        pip list | findstr fastapi
        pip list | findstr uvicorn
        pip list | findstr pyinstaller
        
    - name: Create build directories
      run: |
        Write-Host "ğŸ“ Creating build directories..."
        mkdir -p "${{ github.workspace }}\desktop-app\backend"
        
    - name: Build backend executable with PyInstaller
      run: |
        Write-Host "ğŸ”¨ Building backend executable with PyInstaller CLI..."
        
        # Navigate to app directory for build
        cd "${{ github.workspace }}\app"
        Write-Host "ğŸ“ Working directory: $(pwd)"
        
        # Verify required files exist
        if (!(Test-Path "main_fixed.py")) {
          Write-Host "âŒ main_fixed.py not found in app directory"
          exit 1
        }
        if (!(Test-Path "templates")) {
          Write-Host "âŒ templates directory not found"
          exit 1
        }
        if (!(Test-Path "config_phase3.json")) {
          Write-Host "âŒ config_phase3.json not found"
          exit 1
        }
        
        Write-Host "ğŸ“ App directory contents:"
        dir
        
        # Build using PyInstaller CLI (no spec file)
        pyinstaller --onefile --noconsole --name BackupBackend --paths app --add-data "templates;templates" --add-data "config_phase3.json;." main_fixed.py
        
        Write-Host "âœ… PyInstaller build completed"
        
    - name: Verify backend build
      run: |
        Write-Host "ğŸ” Verifying backend build..."
        $backendPath = "${{ github.workspace }}\app\dist\BackupBackend.exe"
        if (Test-Path $backendPath) {
          Write-Host "âœ… Backend executable built successfully"
          Get-Item $backendPath | Select-Object Name, Length
        } else {
          Write-Host "âŒ Backend executable not found at: $backendPath"
          Write-Host "ğŸ“ Contents of app/dist directory:"
          dir "${{ github.workspace }}\app\dist"
          Write-Host "ğŸ“ Contents of app directory:"
          dir "${{ github.workspace }}\app"
          exit 1
        }
        
    - name: Copy backend to Electron app
      run: |
        Write-Host "ğŸ“‹ Copying backend to Electron app..."
        $source = "${{ github.workspace }}\app\dist\BackupBackend.exe"
        $destination = "${{ github.workspace }}\desktop-app\backend\BackupBackend.exe"
        
        # Verify source exists
        if (!(Test-Path $source)) {
          Write-Host "âŒ Backend executable not found at: $source"
          Write-Host "ğŸ“ Contents of app/dist directory:"
          Get-ChildItem "${{ github.workspace }}\app\dist" | Select-Object Name, Length
          exit 1
        }
        
        # Copy backend
        copy $source $destination
        if (Test-Path $destination) {
          Write-Host "âœ… Backend copied successfully"
          $backendInfo = Get-ChildItem $destination
          Write-Host "ğŸ“Š Backend size: $($backendInfo.Length) bytes"
        } else {
          Write-Host "âŒ Failed to copy backend"
          exit 1
        }
        
    - name: Verify Node.js installation
      run: |
        Write-Host "ğŸ” Verifying Node.js installation..."
        cd "${{ github.workspace }}\desktop-app"
        npm list --depth=0
        
    - name: Build Electron application
      run: |
        Write-Host "ğŸ—ï¸ Building Electron application..."
        cd "${{ github.workspace }}\desktop-app"
        
        # Verify backend exists before building
        $backendPath = "${{ github.workspace }}\desktop-app\backend\BackupBackend.exe"
        if (!(Test-Path $backendPath)) {
          Write-Host "âŒ Backend executable not found at: $backendPath"
          Write-Host "ğŸ“ Contents of desktop-app/backend directory:"
          Get-ChildItem "${{ github.workspace }}\desktop-app\backend" | Select-Object Name, Length
          exit 1
        }
        
        # Verify icon exists before building
        $iconPath = "${{ github.workspace }}\desktop-app\assets\icon.ico"
        if (!(Test-Path $iconPath)) {
          Write-Host "âŒ Icon file not found at: $iconPath"
          exit 1
        }
        
        Write-Host "ğŸ“Š Pre-build verification:"
        Write-Host "- Backend: $(Get-ChildItem $backendPath).Length bytes"
        Write-Host "- Icon: $(Get-ChildItem $iconPath).Length bytes"
        
        # Build with --publish never to avoid GH_TOKEN requirement
        npm run build-win -- --publish=never
        
    - name: Verify installer build
      run: |
        Write-Host "ğŸ” Verifying installer build..."
        $distPath = "${{ github.workspace }}\desktop-app\dist"
        Write-Host "ğŸ“ Contents of dist directory:"
        Get-ChildItem $distPath | Select-Object Name, Length
        
        $installer = Get-ChildItem $distPath\*.exe -Recurse | Where-Object { $_.Name -like "*Setup*" }
        if ($installer) {
          Write-Host "âœ… Installer built successfully"
          Write-Host "ğŸ“Š Installer: $($installer.Name) ($($installer.Length) bytes)"
        } else {
          Write-Host "âŒ Setup installer not found"
          Write-Host "ğŸ” Looking for any .exe files:"
          Get-ChildItem $distPath\*.exe -Recurse | Select-Object Name, Length
          Write-Host "ğŸ“ Full dist directory listing:"
          Get-ChildItem $distPath -Recurse | Select-Object Name, Length
          exit 1
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BackupSystem-Setup-${{ env.APP_VERSION }}
        path: |
          ${{ github.workspace }}\desktop-app\dist\*Setup*.exe
        retention-days: 30
        
    - name: Generate build summary
      run: |
        $installer = Get-ChildItem "${{ github.workspace }}\desktop-app\dist\*Setup*.exe" -Recurse | Where-Object { $_.Name -like "*Setup*" }
        echo "## ğŸ‰ Build Summary" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### âœ… Successfully Built:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Backend**: BackupBackend.exe ($(Get-Item "${{ github.workspace }}\desktop-app\backend\BackupBackend.exe").Length bytes)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Installer**: $($installer.Name) ($($installer.Length) bytes)" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Application Details:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Name**: ${{ env.APP_NAME }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ env.APP_VERSION }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Platform**: Windows (x64)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Backend**: FastAPI + Uvicorn" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Frontend**: Electron Desktop App" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸš€ Installation:" >> $env:GITHUB_STEP_SUMMARY
        echo "1. Download the Setup.exe from the artifacts below" >> $env:GITHUB_STEP_SUMMARY
        echo "2. Run as administrator" >> $env:GITHUB_STEP_SUMMARY
        echo "3. Desktop and Start Menu shortcuts will be created automatically" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸ” Default Login:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Username**: admin" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Password**: admin123" >> $env:GITHUB_STEP_SUMMARY
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: BackupSystem-Setup-*
        merge-multiple: true
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Enterprise Backup System ${{ github.ref_name }}
        body: |
          ## ğŸ‰ Enterprise Backup System ${{ github.ref_name }}
          
          ### âœ¨ Features
          - ğŸ–¥ï¸ **Desktop Application**: Native Windows desktop app
          - ğŸ”’ **Fully Offline**: No internet connection required
          - âš¡ **FastAPI Backend**: High-performance REST API
          - ğŸ¨ **Modern UI**: Clean and intuitive dashboard
          - ğŸ” **Secure**: AES-256 encryption for all backups
          - â° **Automated**: Scheduled backup support
          - ğŸ“Š **Reports**: Detailed backup and restore reports
          
          ### ğŸ“¦ Installation
          1. Download `BackupSystem-Setup.exe` below
          2. Right-click and "Run as administrator"
          3. Follow the installation wizard
          4. Launch from Desktop or Start Menu
          
          ### ğŸ”‘ Default Credentials
          - **Username**: `admin`
          - **Password**: `admin123`
          
          ### ğŸš€ Quick Start
          1. Double-click the desktop shortcut
          2. Dashboard opens automatically
          3. Configure backup destinations
          4. Create your first backup job
          
          ### ğŸ“‹ System Requirements
          - Windows 7 SP1 or later (Windows 10/11 recommended)
          - 4GB RAM minimum (8GB recommended)
          - 500MB disk space + backup storage
          
          ### ğŸ”§ Technical Details
          - **Backend**: FastAPI + Uvicorn (Python 3.12)
          - **Frontend**: Electron Desktop Application
          - **Database**: SQLite (embedded)
          - **Encryption**: AES-256
          
          ---
          
          **Enterprise Software Solutions**  
          Professional Backup & Recovery System
          
        files: |
          *Setup*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
