name: Build Windows Desktop Application

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    env:
      PYTHON_VERSION: '3.12'
      NODE_VERSION: '20'
      APP_NAME: 'Enterprise Backup System'
      APP_VERSION: '1.0.0'
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'backup_system/app/requirements.txt'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'backup_system/desktop-app/package.json'
        
    - name: Create package-lock.json if missing
      run: |
        cd backup_system/desktop-app
        if (!(Test-Path "package-lock.json")) {
          Write-Host "package-lock.json not found, generating..."
          npm install --package-lock-only
        }
        
    - name: Create placeholder icon if missing
      run: |
        cd backup_system/desktop-app
        if (!(Test-Path "assets/icon.ico")) {
          Write-Host "Creating placeholder icon..."
          mkdir -p assets
          # Create a simple placeholder file
          echo "Placeholder icon file" > assets/icon.txt
        }
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r backup_system/app/requirements.txt
        pip install pyinstaller==6.3.0
        
    - name: Verify Python installation
      run: |
        python --version
        pip list | findstr fastapi
        pip list | findstr pyinstaller
        
    - name: Create build directories
      run: |
        mkdir -p backup_system/desktop-app/backend
        mkdir -p backup_system/desktop-app/dist
        
    - name: Build backend executable with PyInstaller
      run: |
        cd backup_system
        pyinstaller --onefile --noconsole --name BackupBackend --add-data "app/templates;templates" --add-data "app/config_phase3.json;." app/main_fixed.py
        
    - name: Verify backend build
      run: |
        if (Test-Path "backup_system/dist/BackupBackend.exe") {
          Write-Host "âœ… Backend executable built successfully"
          Get-Item backup_system/dist/BackupBackend.exe | Select-Object Name, Length
        } else {
          Write-Error "âŒ Backend executable not found"
          exit 1
        }
        
    - name: Copy backend to Electron app
      run: |
        copy backup_system/dist/BackupBackend.exe backup_system/desktop-app/backend/
        
    - name: Install Node.js dependencies
      run: |
        cd backup_system/desktop-app
        npm install --production=false
        
    - name: Add node-fetch dependency
      run: |
        cd backup_system/desktop-app
        npm install node-fetch@2.7.0 --save
        
    - name: Build Electron application
      run: |
        cd backup_system/desktop-app
        npm run build-win
        
    - name: Verify installer build
      run: |
        $installer = Get-ChildItem backup_system/desktop-app/dist/*.exe -Recurse | Where-Object { $_.Name -like "*Setup*" }
        if ($installer) {
          Write-Host "âœ… Installer built successfully"
          $installer | Select-Object Name, Length
        } else {
          Write-Error "âŒ Setup installer not found"
          Get-ChildItem backup_system/desktop-app/dist/*.exe -Recurse | Select-Object Name, Length
          exit 1
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BackupSystem-Setup-${{ env.APP_VERSION }}
        path: |
          backup_system/desktop-app/dist/*Setup*.exe
        retention-days: 30
        
    - name: Generate build summary
      run: |
        $installer = Get-ChildItem backup_system/desktop-app/dist/*Setup*.exe -Recurse | Where-Object { $_.Name -like "*Setup*" }
        echo "## ğŸ‰ Build Summary" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### âœ… Successfully Built:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Backend**: BackupBackend.exe ($(Get-Item backup_system/desktop-app/backend/BackupBackend.exe).Length bytes)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Installer**: $($installer.Name) ($($installer.Length) bytes)" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Application Details:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Name**: ${{ env.APP_NAME }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ env.APP_VERSION }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Platform**: Windows (x64)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Backend**: FastAPI + Uvicorn" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Frontend**: Electron Desktop App" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸš€ Installation:" >> $env:GITHUB_STEP_SUMMARY
        echo "1. Download the Setup.exe from the artifacts below" >> $env:GITHUB_STEP_SUMMARY
        echo "2. Run as administrator" >> $env:GITHUB_STEP_SUMMARY
        echo "3. Desktop and Start Menu shortcuts will be created automatically" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸ” Default Login:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Username**: admin" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Password**: admin123" >> $env:GITHUB_STEP_SUMMARY
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: BackupSystem-Setup-*
        merge-multiple: true
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Enterprise Backup System ${{ github.ref_name }}
        body: |
          ## ğŸ‰ Enterprise Backup System ${{ github.ref_name }}
          
          ### âœ¨ Features
          - ğŸ–¥ï¸ **Desktop Application**: Native Windows desktop app
          - ğŸ”’ **Fully Offline**: No internet connection required
          - âš¡ **FastAPI Backend**: High-performance REST API
          - ğŸ¨ **Modern UI**: Clean and intuitive dashboard
          - ğŸ” **Secure**: AES-256 encryption for all backups
          - â° **Automated**: Scheduled backup support
          - ğŸ“Š **Reports**: Detailed backup and restore reports
          
          ### ğŸ“¦ Installation
          1. Download `BackupSystem-Setup.exe` below
          2. Right-click and "Run as administrator"
          3. Follow the installation wizard
          4. Launch from Desktop or Start Menu
          
          ### ğŸ”‘ Default Credentials
          - **Username**: `admin`
          - **Password**: `admin123`
          
          ### ğŸš€ Quick Start
          1. Double-click the desktop shortcut
          2. Dashboard opens automatically
          3. Configure backup destinations
          4. Create your first backup job
          
          ### ğŸ“‹ System Requirements
          - Windows 7 SP1 or later (Windows 10/11 recommended)
          - 4GB RAM minimum (8GB recommended)
          - 500MB disk space + backup storage
          
          ### ğŸ”§ Technical Details
          - **Backend**: FastAPI + Uvicorn (Python 3.12)
          - **Frontend**: Electron Desktop Application
          - **Database**: SQLite (embedded)
          - **Encryption**: AES-256
          
          ---
          
          **Enterprise Software Solutions**  
          Professional Backup & Recovery System
          
        files: |
          *Setup*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
