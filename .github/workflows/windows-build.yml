name: Build Windows Desktop Application

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    env:
      PYTHON_VERSION: '3.12'
      NODE_VERSION: '20'
      APP_NAME: 'Enterprise Backup System'
      APP_VERSION: '1.0.0'
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Show workspace structure
      run: |
        echo "=== WORKSPACE DEBUG ==="
        echo "Workspace: ${{ github.workspace }}"
        echo "Current directory: $(pwd)"
        dir
        echo ""
        echo "=== CHECKING app DIRECTORY ==="
        if (Test-Path "${{ github.workspace }}\app") {
          echo "âœ… app directory found"
          dir "${{ github.workspace }}\app"
        } else {
          echo "âŒ app directory not found"
          dir "${{ github.workspace }}"
          exit 1
        }
        echo ""
        echo "=== CHECKING desktop-app DIRECTORY ==="
        if (Test-Path "${{ github.workspace }}\desktop-app") {
          echo "âœ… desktop-app directory found"
          dir "${{ github.workspace }}\desktop-app"
        } else {
          echo "âŒ desktop-app directory not found"
          dir "${{ github.workspace }}"
          exit 1
        }
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: '${{ github.workspace }}\app\requirements.txt'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '${{ github.workspace }}\desktop-app\package.json'
        
    - name: Create placeholder assets if missing
      run: |
        cd "${{ github.workspace }}\desktop-app"
        if (!(Test-Path "assets")) {
          Write-Host "ğŸ“ Creating assets directory..."
          mkdir assets
        }
        if (!(Test-Path "assets\icon.ico")) {
          Write-Host "ğŸ¨ Creating placeholder icon.ico..."
          echo "Placeholder icon file" > assets\icon.txt
          # Create a minimal ICO file placeholder
          $icoBytes = [byte[]](0x00,0x00,0x01,0x00,0x01,0x00,0x10,0x10,0x00,0x00,0x01,0x00,0x08,0x00,0x68,0x04,0x00,0x00,0x16,0x00,0x00,0x00)
          [System.IO.File]::WriteAllBytes("assets\icon.ico", $icoBytes)
          Write-Host "âœ… Created assets\icon.ico"
        }
        if (!(Test-Path "assets\installer.nsh")) {
          Write-Host "ğŸ“„ Creating placeholder installer.nsh..."
          echo "; Custom installer script" > assets\installer.nsh
          Write-Host "âœ… Created assets\installer.nsh"
        }
        Write-Host "ğŸ“ Assets directory contents:"
        dir assets
        
    - name: Install Node.js dependencies
      run: |
        Write-Host "ğŸ“¦ Installing Node.js dependencies..."
        cd "${{ github.workspace }}\desktop-app"
        npm install --production=false
        
    - name: Install Python dependencies
      run: |
        Write-Host "ğŸ Installing Python dependencies..."
        python -m pip install --upgrade pip setuptools wheel
        pip install -r "${{ github.workspace }}\app\requirements.txt"
        pip install pyinstaller==6.3.0
        
    - name: Verify Python installation
      run: |
        Write-Host "ğŸ” Verifying Python installation..."
        python --version
        pip list | findstr fastapi
        pip list | findstr uvicorn
        pip list | findstr pyinstaller
        
    - name: Create build directories
      run: |
        Write-Host "ğŸ“ Creating build directories..."
        mkdir -p "${{ github.workspace }}\desktop-app\backend"
        mkdir -p "${{ github.workspace }}\desktop-app\dist"
        
    - name: Build backend executable with PyInstaller
      run: |
        Write-Host "ğŸ”¨ Building backend executable..."
        cd "${{ github.workspace }}\desktop-app"
        pyinstaller --clean backend_build.spec --noconfirm
        
    - name: Verify backend build
      run: |
        Write-Host "ğŸ” Verifying backend build..."
        $backendPath = "${{ github.workspace }}\desktop-app\dist\BackupBackend.exe"
        if (Test-Path $backendPath) {
          Write-Host "âœ… Backend executable built successfully"
          Get-Item $backendPath | Select-Object Name, Length
        } else {
          Write-Host "âŒ Backend executable not found at: $backendPath"
          Write-Host "ğŸ“ Contents of dist directory:"
          dir "${{ github.workspace }}\desktop-app\dist"
          Write-Host "ğŸ“ Contents of desktop-app directory:"
          dir "${{ github.workspace }}\desktop-app"
          exit 1
        }
        
    - name: Copy backend to Electron app
      run: |
        Write-Host "ğŸ“‹ Copying backend to Electron app..."
        $source = "${{ github.workspace }}\desktop-app\dist\BackupBackend.exe"
        $destination = "${{ github.workspace }}\desktop-app\backend\BackupBackend.exe"
        copy $source $destination
        if (Test-Path $destination) {
          Write-Host "âœ… Backend copied successfully"
          Get-Item $destination | Select-Object Name, Length
        } else {
          Write-Host "âŒ Failed to copy backend"
          exit 1
        }
        
    - name: Verify Node.js installation
      run: |
        Write-Host "ğŸ” Verifying Node.js installation..."
        cd "${{ github.workspace }}\desktop-app"
        npm list --depth=0
        
    - name: Build Electron application
      run: |
        Write-Host "ğŸ—ï¸ Building Electron application..."
        cd "${{ github.workspace }}\desktop-app"
        npm run build-win
        
    - name: Verify installer build
      run: |
        Write-Host "ğŸ” Verifying installer build..."
        $distPath = "${{ github.workspace }}\desktop-app\dist"
        Write-Host "ğŸ“ Contents of dist directory:"
        dir $distPath
        
        $installer = Get-ChildItem $distPath\*.exe -Recurse | Where-Object { $_.Name -like "*Setup*" }
        if ($installer) {
          Write-Host "âœ… Installer built successfully"
          $installer | Select-Object Name, Length
        } else {
          Write-Host "âŒ Setup installer not found"
          Write-Host "ğŸ” Looking for any .exe files:"
          Get-ChildItem $distPath\*.exe -Recurse | Select-Object Name, Length
          exit 1
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BackupSystem-Setup-${{ env.APP_VERSION }}
        path: |
          ${{ github.workspace }}\desktop-app\dist\*Setup*.exe
        retention-days: 30
        
    - name: Generate build summary
      run: |
        $installer = Get-ChildItem "${{ github.workspace }}\desktop-app\dist\*Setup*.exe" -Recurse | Where-Object { $_.Name -like "*Setup*" }
        echo "## ğŸ‰ Build Summary" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### âœ… Successfully Built:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Backend**: BackupBackend.exe ($(Get-Item "${{ github.workspace }}\desktop-app\backend\BackupBackend.exe").Length bytes)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Installer**: $($installer.Name) ($($installer.Length) bytes)" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Application Details:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Name**: ${{ env.APP_NAME }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ env.APP_VERSION }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Platform**: Windows (x64)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Backend**: FastAPI + Uvicorn" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Frontend**: Electron Desktop App" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸš€ Installation:" >> $env:GITHUB_STEP_SUMMARY
        echo "1. Download the Setup.exe from the artifacts below" >> $env:GITHUB_STEP_SUMMARY
        echo "2. Run as administrator" >> $env:GITHUB_STEP_SUMMARY
        echo "3. Desktop and Start Menu shortcuts will be created automatically" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸ” Default Login:" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Username**: admin" >> $env:GITHUB_STEP_SUMMARY
        echo "- **Password**: admin123" >> $env:GITHUB_STEP_SUMMARY
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: BackupSystem-Setup-*
        merge-multiple: true
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Enterprise Backup System ${{ github.ref_name }}
        body: |
          ## ğŸ‰ Enterprise Backup System ${{ github.ref_name }}
          
          ### âœ¨ Features
          - ğŸ–¥ï¸ **Desktop Application**: Native Windows desktop app
          - ğŸ”’ **Fully Offline**: No internet connection required
          - âš¡ **FastAPI Backend**: High-performance REST API
          - ğŸ¨ **Modern UI**: Clean and intuitive dashboard
          - ğŸ” **Secure**: AES-256 encryption for all backups
          - â° **Automated**: Scheduled backup support
          - ğŸ“Š **Reports**: Detailed backup and restore reports
          
          ### ğŸ“¦ Installation
          1. Download `BackupSystem-Setup.exe` below
          2. Right-click and "Run as administrator"
          3. Follow the installation wizard
          4. Launch from Desktop or Start Menu
          
          ### ğŸ”‘ Default Credentials
          - **Username**: `admin`
          - **Password**: `admin123`
          
          ### ğŸš€ Quick Start
          1. Double-click the desktop shortcut
          2. Dashboard opens automatically
          3. Configure backup destinations
          4. Create your first backup job
          
          ### ğŸ“‹ System Requirements
          - Windows 7 SP1 or later (Windows 10/11 recommended)
          - 4GB RAM minimum (8GB recommended)
          - 500MB disk space + backup storage
          
          ### ğŸ”§ Technical Details
          - **Backend**: FastAPI + Uvicorn (Python 3.12)
          - **Frontend**: Electron Desktop Application
          - **Database**: SQLite (embedded)
          - **Encryption**: AES-256
          
          ---
          
          **Enterprise Software Solutions**  
          Professional Backup & Recovery System
          
        files: |
          *Setup*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
